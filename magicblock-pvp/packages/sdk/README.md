# MagicBlock SDK\n\nA comprehensive TypeScript SDK for building PvP games on MagicBlock's Ephemeral Rollups with integrated VRF (Verifiable Random Functions), TEE (Trusted Execution Environment) verification, and optimized session management.\n\n## Features\n\n- **ðŸš€ Ephemeral Rollups Integration**: High-performance gasless transactions with L1 settlement\n- **ðŸŽ² ECVRF Implementation**: RFC 9381 compliant Edwards25519 VRF with <10ms latency\n- **ðŸ”’ TEE Attestation**: Vendor-agnostic verification (Intel SGX, AMD SEV, ARM TrustZone)\n- **âš¡ Session Management**: Optimized gasless transaction batching and cost tracking\n- **ðŸŽ® Game Client**: Complete PvP game framework with match management\n- **ðŸ“Š Performance Monitoring**: Real-time metrics and cost optimization\n\n## Installation\n\n```bash\nnpm install @magicblock-pvp/sdk\n```\n\n## Quick Start\n\n### Game Client (Recommended)\n\n```typescript\nimport { GameClient } from '@magicblock-pvp/sdk';\nimport { Connection, PublicKey } from '@solana/web3.js';\n\nconst config = {\n  connection: new Connection('https://api.devnet.solana.com'),\n  rollupUrl: 'https://rollup-dev.magicblock.gg',\n  chainId: 1,\n  gaslessEnabled: true,\n  sessionTimeout: 3600000, // 1 hour\n  maxRetries: 3,\n  vrf: {\n    curve: 'edwards25519' as const,\n    hashSuite: 'sha512' as const,\n    latencyTarget: 10\n  },\n  session: {\n    maxDuration: 3600000,\n    gaslessTransactions: true,\n    autoRenew: true,\n    batchSize: 10\n  },\n  teeVerification: true\n};\n\nconst gameClient = new GameClient(config);\nawait gameClient.initialize();\n\n// Create a match\nconst players = [player1PubKey, player2PubKey];\nconst { match, rollupId } = await gameClient.createMatch(players);\n\n// Execute game action with VRF\nconst action = {\n  type: ActionType.Attack,\n  player: player1PubKey,\n  data: { target: player2PubKey, damage: 25 },\n  timestamp: Date.now()\n};\n\nconst result = await gameClient.executeGameAction(\n  match.id.toString(), \n  action\n);\n\n// Select winners using VRF\nconst winners = await gameClient.selectMatchWinners(\n  match.id.toString(),\n  1, // number of winners\n  [100, 150] // player weights\n);\n\n// Commit to L1\nconst commitment = await gameClient.commitMatchToL1(match.id.toString());\n```\n\n### VRF Client (Standalone)\n\n```typescript\nimport { VRFClient, ECVRF } from '@magicblock-pvp/sdk';\n\nconst vrfClient = new VRFClient({\n  curve: 'edwards25519',\n  hashSuite: 'sha512',\n  latencyTarget: 10\n});\n\nawait vrfClient.initialize();\n\n// Generate randomness\nconst message = new TextEncoder().encode('game_seed_123');\nconst vrfOutput = await vrfClient.generateRandomness(message);\n\n// Verify randomness\nconst isValid = await vrfClient.verifyRandomness(\n  vrfClient.getPublicKey()!,\n  vrfOutput.proof,\n  message\n);\n\n// Select winners proportionally\nconst winnerSelection = await vrfClient.selectWinners({\n  totalParticipants: 10,\n  winnerCount: 3,\n  seed: message,\n  weights: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n});\n```\n\n### TEE Attestation Verification\n\n```typescript\nimport { TEEAttestationVerifier } from '@magicblock-pvp/sdk';\n\n// Verify attestation\nconst result = await TEEAttestationVerifier.verifyAttestation(attestation);\n\nif (result.isValid) {\n  console.log(`Verified ${result.vendor} attestation`);\n} else {\n  console.error(`Verification failed: ${result.error}`);\n}\n\n// Extract measurement\nconst measurement = TEEAttestationVerifier.extractMeasurement(attestation);\n```\n\n## Architecture\n\n### Core Components\n\n1. **GameClient**: High-level interface combining all SDK features\n2. **MagicBlockClient**: Direct rollup integration with session management\n3. **VRFClient**: ECVRF implementation with winner selection\n4. **SessionManager**: Gasless transaction batching and lifecycle management\n5. **CostTracker**: Fee optimization and spending analytics\n6. **TransactionQueue**: Priority-based transaction processing\n7. **RollupVerifier**: L1 proof verification\n8. **TEEAttestationVerifier**: Multi-vendor TEE verification\n\n### Data Flow\n\n```\nGame Action â†’ VRF (if random) â†’ TEE Verify â†’ Rollup Execute â†’ Queue â†’ L1 Settle\n     â†“              â†“              â†“              â†“         â†“\n  Session      Randomness     Attestation    Cost Track  Proof\n```\n\n## VRF Specification\n\n### ECVRF-EDWARDS25519-SHA512-Elligator2\n\n- **Curve**: Edwards25519 (NOT Ristretto encoding)\n- **Hash Suite**: SHA-512\n- **Latency Target**: <10ms for proof generation/verification\n- **Winner Selection**: Proportional with rejection sampling\n- **Security**: RFC 9381 compliant\n\n### Performance Targets\n\n- VRF Generation: <10ms\n- VRF Verification: <10ms\n- Rollup Settlement: <5s\n- L1 Confirmation: <30s\n- Throughput: 1000+ TPS\n\n## TEE Support\n\n### Supported Vendors\n\n- **Intel SGX**: Quote verification with MRENCLAVE/MRSIGNER\n- **AMD SEV**: Report verification with measurement data\n- **ARM TrustZone**: Generic attestation verification\n- **Generic**: Signature-based verification\n\n### Attestation Validation\n\n- Timestamp verification (max 5 minutes age)\n- Cryptographic signature verification\n- Vendor-specific format validation\n- Measurement extraction and verification\n\n## Session Management\n\n### Features\n\n- **Gasless Transactions**: Batch processing for cost optimization\n- **Auto-Renewal**: Seamless session extension\n- **Cost Tracking**: Real-time spend monitoring\n- **Fee Optimization**: Dynamic priority adjustment\n- **Metrics**: Performance and success rate tracking\n\n### Cost Optimization\n\n```typescript\nconst costTracker = gameClient.getCostTracking();\n\n// Get optimization suggestions\nconst suggestions = costTracker.getOptimizationSuggestions();\n\n// Estimate transaction cost\nconst estimate = await costTracker.estimateTransactionCost(\n  'game_action',\n  200000, // compute units\n  'medium' // priority\n);\n```\n\n## Testing\n\n```bash\n# Run all tests\nnpm test\n\n# Run specific test suites\nnpm test -- --testPathPattern=vrf\nnpm test -- --testPathPattern=integration\n\n# Run with coverage\nnpm run test:coverage\n\n# Watch mode\nnpm run test:watch\n```\n\n## Error Handling\n\n```typescript\nimport { MagicBlockError, VRFError, TEEError, SessionError } from '@magicblock-pvp/sdk';\n\ntry {\n  await gameClient.executeGameAction(matchId, action);\n} catch (error) {\n  if (error instanceof VRFError) {\n    console.error('VRF operation failed:', error.message);\n  } else if (error instanceof SessionError) {\n    console.error('Session issue:', error.message);\n  } else {\n    console.error('General error:', error);\n  }\n}\n```\n\n## Events\n\n```typescript\n// Listen to SDK events\ngameClient.on('match:created', ({ match, vrfOutput }) => {\n  console.log('Match created:', match.id);\n});\n\ngameClient.on('vrf:generated', (output) => {\n  console.log('VRF output generated:', output.beta);\n});\n\ngameClient.on('transaction:confirmed', (signature) => {\n  console.log('Transaction confirmed:', signature);\n});\n\ngameClient.on('session:expired', (sessionId) => {\n  console.log('Session expired:', sessionId);\n});\n```\n\n## Configuration Options\n\n```typescript\ninterface GameClientConfig {\n  // Network settings\n  connection: Connection;\n  rollupUrl: string;\n  chainId: number;\n  \n  // Transaction settings\n  gaslessEnabled: boolean;\n  sessionTimeout: number;\n  maxRetries: number;\n  \n  // VRF configuration\n  vrf: {\n    curve: 'edwards25519';\n    hashSuite: 'sha512';\n    latencyTarget: number; // milliseconds\n    seed?: Uint8Array;\n  };\n  \n  // Session management\n  session: {\n    maxDuration: number;\n    gaslessTransactions: boolean;\n    autoRenew: boolean;\n    batchSize: number;\n  };\n  \n  // Security\n  teeVerification: boolean;\n}\n```\n\n## Performance Monitoring\n\n```typescript\n// Get comprehensive status\nconst status = gameClient.getStatus();\nconsole.log({\n  activeMatches: status.activeMatches,\n  queueMetrics: status.queueMetrics,\n  vrfMetrics: status.vrfMetrics,\n  costTracking: status.costTracking\n});\n\n// Get VRF performance\nconst vrfMetrics = vrfClient.getMetrics();\nconsole.log({\n  averageLatency: vrfMetrics.averageLatency,\n  totalRequests: vrfMetrics.totalRequests,\n  successRate: (1 - vrfMetrics.failedRequests / vrfMetrics.totalRequests)\n});\n```\n\n## Best Practices\n\n### 1. Session Management\n- Use auto-renewal for long-running games\n- Monitor session metrics for optimization\n- Batch related transactions together\n\n### 2. VRF Usage\n- Generate seed from game state for determinism\n- Use proportional selection for fair outcomes\n- Verify proofs from other parties\n\n### 3. Cost Optimization\n- Use appropriate priority levels\n- Monitor spending patterns\n- Implement suggested optimizations\n\n### 4. Error Recovery\n- Handle network failures gracefully\n- Implement retry logic with exponential backoff\n- Log errors with sufficient context\n\n## Contributing\n\n1. Fork the repository\n2. Create your feature branch (`git checkout -b feature/amazing-feature`)\n3. Commit your changes (`git commit -m 'Add amazing feature'`)\n4. Push to the branch (`git push origin feature/amazing-feature`)\n5. Open a Pull Request\n\n## License\n\nMIT License - see the [LICENSE](LICENSE) file for details.\n\n## Support\n\n- Documentation: [https://docs.magicblock.gg](https://docs.magicblock.gg)\n- Discord: [https://discord.gg/magicblock](https://discord.gg/magicblock)\n- Issues: [GitHub Issues](https://github.com/magicblock-labs/magicblock-pvp/issues)\n\n---\n\n**Built for the future of on-chain gaming** ðŸŽ®âš¡"